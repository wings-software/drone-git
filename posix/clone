#!/bin/sh

set -e

echo "[DEBUG] Script started 3"

# if PLUGIN_ONLY_COPY_FILE_CONTENT is set, only copy the file content
if [ "$PLUGIN_ONLY_COPY_FILE_CONTENT" = "true" ]; then
	echo "[DEBUG] PLUGIN_ONLY_COPY_FILE_CONTENT is true, calling copy-file-content and exiting"
	copy-file-content
	exit 0
fi

# force the home directory path.
if [ "$HOME" != "/home/drone" ]; then
	echo "[DEBUG] HOME is not /home/drone, current HOME=$HOME"
	if [ -d "/home/drone" ]; then
		echo "[DEBUG] setting default home directory"
		export HOME=/home/drone
	fi
fi

if [ ! -z "${DRONE_WORKSPACE}" ]; then
	echo "[DEBUG] DRONE_WORKSPACE is set to ${DRONE_WORKSPACE}, creating directory and changing to it"	
	mkdir -p ${DRONE_WORKSPACE}
	cd ${DRONE_WORKSPACE}
	cat <<EOF > root/.netrc
machine ${DRONE_NETRC_MACHINE}
login ${DRONE_NETRC_USERNAME}
password ${DRONE_NETRC_PASSWORD}
EOF
	chmod 600 .netrc
	 
fi

# if the netrc enviornment variables exist, write
# the netrc file.

if [ ! -z "${DRONE_NETRC_MACHINE}" ]; then

	cat <<EOF > ${HOME}/.netrc
machine ${DRONE_NETRC_MACHINE}
login ${DRONE_NETRC_USERNAME}
password ${DRONE_NETRC_PASSWORD}
EOF

	echo "[DEBUG] .netrc file written and permissions not set to 600"
	cat ${HOME}/.netrc
fi

# if the ssh_key environment variable exists, write
# the ssh key and add the netrc machine to the
# known hosts file.

if [ ! -z "${DRONE_SSH_KEY}" ]; then
	echo "[DEBUG] DRONE_SSH_KEY is set. Setting up SSH configuration."
	mkdir -p ${HOME}/.ssh
	echo "$DRONE_SSH_KEY" > ${HOME}/.ssh/id_rsa
	chmod 600 ${HOME}/.ssh/id_rsa
	echo "[DEBUG] Written SSH private key to ${HOME}/.ssh/id_rsa"

	touch ${HOME}/.ssh/known_hosts
	chmod 600 ${HOME}/.ssh/known_hosts
	echo "[DEBUG] Initialized known_hosts file at ${HOME}/.ssh/known_hosts"



	SSH_PORT_FLAG=""
	if [ ! -z "${DRONE_NETRC_PORT}" ]; then
		SSH_PORT_FLAG="-p ${DRONE_NETRC_PORT}"
		echo "[DEBUG] SSH_PORT_FLAG set to ${SSH_PORT_FLAG}"
	fi

	SSH_KEYSCAN_TIMEOUT_FLAG=""
	if [ ! -z "${PLUGIN_SSH_KEYSCAN_TIMEOUT}" ]; then
		SSH_KEYSCAN_TIMEOUT_FLAG="-T ${PLUGIN_SSH_KEYSCAN_TIMEOUT}"
		echo "[DEBUG] SSH_KEYSCAN_TIMEOUT_FLAG set to ${SSH_KEYSCAN_TIMEOUT_FLAG}"
	fi

	if [ ! -z "${DRONE_SSH_PASSPHRASE}" ]; then
		echo "[DEBUG] DRONE_SSH_PASSPHRASE is set, updating ssh passphrase"
		ssh-keygen -p -f ${HOME}/.ssh/id_rsa -P ${DRONE_SSH_PASSPHRASE} -N ""
	fi

	echo "[DEBUG] Running ssh-keyscan for ${DRONE_NETRC_MACHINE}"
	ssh-keyscan -H ${SSH_PORT_FLAG} ${SSH_KEYSCAN_TIMEOUT_FLAG} ${DRONE_NETRC_MACHINE} > ${HOME}/.ssh/known_hosts 2> /dev/null
	export GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=${HOME}/.ssh/known_hosts -i ${HOME}/.ssh/id_rsa ${SSH_PORT_FLAG} -F /dev/null"
fi

# AWS codecommit support using AWS access key & secret key
# Refer: https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-https-unixes.html

if [ ! -z "$DRONE_AWS_ACCESS_KEY" ]; then
	echo "[DEBUG] AWS CodeCommit auth detected, configuring aws credentials"
	aws configure set aws_access_key_id $DRONE_AWS_ACCESS_KEY
	aws configure set aws_secret_access_key $DRONE_AWS_SECRET_KEY
	aws configure set default.region $DRONE_AWS_REGION

	git config --global credential.helper '!aws codecommit credential-helper $@'
	git config --global credential.UseHttpPath true
	echo "[DEBUG] AWS CodeCommit git credential helper configured"
fi

# configure git global behavior and parameters via the
# following environment variables:


if [ -z "${DRONE_COMMIT_AUTHOR_NAME}" ]; then
	echo "[DEBUG] DRONE_COMMIT_AUTHOR_NAME not set, defaulting to 'drone'"
	export DRONE_COMMIT_AUTHOR_NAME=drone
fi

if [ -z "${DRONE_COMMIT_AUTHOR_EMAIL}" ]; then
	echo "[DEBUG] DRONE_COMMIT_AUTHOR_EMAIL not set, defaulting to 'drone@localhost'"
	export DRONE_COMMIT_AUTHOR_EMAIL=drone@localhost
fi

export GIT_AUTHOR_NAME=${DRONE_COMMIT_AUTHOR_NAME}
export GIT_AUTHOR_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}
export GIT_COMMITTER_NAME=${DRONE_COMMIT_AUTHOR_NAME}
export GIT_COMMITTER_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}

# invoke the sub-script based on the drone event type.
# TODO we should ultimately look at the ref, since
# we need something compatible with deployment events.
echo "[DEBUG] Git identity configured: ${GIT_AUTHOR_NAME} <${GIT_AUTHOR_EMAIL}>"

CLONE_TYPE=$DRONE_BUILD_EVENT
case $DRONE_COMMIT_REF in
  refs/tags/* ) CLONE_TYPE=tag ;;
  refs/pull/* ) CLONE_TYPE=pull_request ;;
  refs/pull-request/* ) CLONE_TYPE=pull_request ;;
  refs/merge-requests/* ) CLONE_TYPE=pull_request ;;
esac

common

case $CLONE_TYPE in
pull_request)
	echo "[DEBUG] Running clone-pull-request"
	clone-pull-request
	;;
tag)
	echo "[DEBUG] Running clone-tag"
	clone-tag
	;;
*)
	echo "[DEBUG] Running clone-commit"
	clone-commit
	;;
esac

post-fetch

copy-file-content

if [ -n "$PLUGIN_BUILD_TOOL_FILE" ] && [ -z "$CI_DISABLE_TELEMETRY" ]; then
    get-buildtool-lang || true
fi

echo "[DEBUG] Script completed"